#include "DabbleESP32.h"
#include <esp_bt.h>  // Required for esp_ble_tx_power_set

#define FORWARD_LEFT_PIN 21
#define FORWARD_RIGHT_PIN 12
#define LED_PIN 22

bool ledState = false;
bool lastTriangleState = false;

void setup() {
  Serial.begin(115200);

  // Boost Bluetooth transmission power to maximum
  esp_ble_tx_power_set(ESP_BLE_PWR_TYPE_DEFAULT, ESP_PWR_LVL_P9);

  // Setup output pins
  pinMode(FORWARD_LEFT_PIN, OUTPUT);
  pinMode(FORWARD_RIGHT_PIN, OUTPUT);
  pinMode(LED_PIN, OUTPUT);

  Dabble.begin("ESP32-Dabble");  // This name appears in the Dabble app
}

void loop() {
  Dabble.processInput();  // Process Bluetooth input from Dabble app

  // Default state: turn off movement pins unless a direction is pressed
  digitalWrite(FORWARD_LEFT_PIN, LOW);
  digitalWrite(FORWARD_RIGHT_PIN, LOW);

  // Movement controls
  if (GamePad.isUpPressed()) {
    digitalWrite(FORWARD_LEFT_PIN, HIGH);
    digitalWrite(FORWARD_RIGHT_PIN, HIGH);
  } else if (GamePad.isLeftPressed()) {
    digitalWrite(FORWARD_LEFT_PIN, HIGH);
  } else if (GamePad.isRightPressed()) {
    digitalWrite(FORWARD_RIGHT_PIN, HIGH);
  }

  // Triangle button toggles LED on pin 22
  bool currentTriangleState = GamePad.isTrianglePressed();
  if (currentTriangleState && !lastTriangleState) {
    ledState = !ledState;
    digitalWrite(LED_PIN, ledState ? HIGH : LOW);
  }
  lastTriangleState = currentTriangleState;
}
